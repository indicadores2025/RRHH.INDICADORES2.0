{% extends 'base.html' %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 40px auto; border-radius: 2rem; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37); background: linear-gradient(135deg, #f8fafc, #1e293b 90%); padding: 2rem;">
    <h2 class="text-3xl font-bold text-center mb-6" style="color:#0f172a;">Estadísticas Descriptivas</h2>
    <form method="post" class="mb-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col">
                <label for="unidad_id" class="block font-semibold mb-1">Unidad</label>
                <select id="unidad_id" name="unidad_id"
                    class="form-select w-full p-2 rounded-lg shadow border-2 border-slate-300 bg-white"
                    style="background:rgba(255,255,255,0.90); min-width:220px;">
                    <option value="todas">Todas</option>
                    {% for u in unidades %}
                        <option value="{{u.id}}" {% if unidad_id == u.id|string %}selected{% endif %}>{{u.nombre}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex flex-col">
                <label for="pregunta_id" class="block font-semibold mb-1">Pregunta</label>
                <select id="pregunta_id" name="pregunta_id"
                    class="form-select w-full p-2 rounded-lg shadow border-2 border-slate-300 bg-white"
                    style="background:rgba(255,255,255,0.90); min-width:220px;">
                    <option value="todas">Todas</option>
                    {% for p in preguntas %}
                        <option value="{{p.id}}" {% if pregunta_id == p.id|string %}selected{% endif %}>{{p.texto|truncate(200)}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="text-center mt-6">
            <button type="submit" class="px-6 py-2 rounded-xl font-bold shadow-lg" style="background: #0ea5e9; color: #fff;">Calcular</button>
        </div>
    </form>

    {% if meses_calculados %}
        <div class="mb-6 text-center text-gray-800 text-base font-semibold">
            <b>Meses considerados:</b> {{ meses_calculados|join(', ') }}
        </div>
    {% endif %}

    {% if resultados %}
        <div class="mt-4 p-6 bg-white bg-opacity-60 rounded-2xl shadow-xl text-gray-900">
            {% if resultados.mensaje %}
                <p class="text-center text-lg font-semibold">{{ resultados.mensaje }}</p>
            {% else %}
            <div class="grid grid-cols-2 gap-4 text-lg">
                <div><b>Promedio:</b> {{resultados.promedio}}</div>
                <div><b>Mediana:</b> {{resultados.mediana}}</div>
                <div><b>Máximo:</b> {{resultados.maximo}}</div>
                <div><b>Mínimo:</b> {{resultados.minimo}}</div>
                <div><b>Suma total:</b> {{resultados.suma}}</div>
                <div><b>Desviación estándar:</b> {{resultados.desviacion}}</div>
                <div><b>Cantidad:</b> {{resultados.conteo}}</div>
                <div><b>Porcentaje sobre total:</b> {{(resultados.suma/resultados.conteo*100)|round(2) if resultados.conteo > 0 else 0}} %</div>
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const unidadSelect = document.getElementById('unidad_id');
    const preguntaSelect = document.getElementById('pregunta_id');

    function cargarPreguntas(unidadId, seleccionada) {
        preguntaSelect.innerHTML = '<option value="todas">Cargando...</option>';
        fetch(`/api/preguntas_por_unidad/${unidadId}`)
            .then(response => response.json())
            .then(data => {
                preguntaSelect.innerHTML = '<option value="todas">Todas</option>';
                data.preguntas.forEach(p => {
                    let opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.texto.substring(0,200);
                    if (seleccionada && seleccionada == String(p.id)) {
                        opt.selected = true;
                    }
                    preguntaSelect.appendChild(opt);
                });
            });
    }

    // Si ya viene una unidad seleccionada, recarga sus preguntas al cargar la página
    {% if unidad_id and unidad_id != 'todas' %}
        cargarPreguntas("{{unidad_id}}", "{{pregunta_id}}");
    {% endif %}

    // Cada vez que cambia la unidad, se actualizan las preguntas
    unidadSelect.addEventListener('change', function() {
        cargarPreguntas(this.value, null);
    });
});
</script>
{% endblock %}
