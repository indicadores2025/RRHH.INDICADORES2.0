{% extends 'base.html' %}
{% block title %}Estadísticas y Proyecciones{% endblock %}

{% block content %}
<style>
.card-graficos {
    margin: 32px auto;
    padding: 32px 40px 24px 40px;
    border-radius: 28px;
    background: #fff;
    box-shadow: 0 8px 32px 0 rgba(21, 21, 21, 0.13), 0 1.5px 8px 0 rgba(70,70,70,0.10);
    max-width: 980px;
}
.filtros-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-bottom: 22px;
}
.filtros-form label {
    display: flex;
    flex-direction: column;
    font-weight: 600;
    font-size: 1.05em;
}
select, .btn, input[type="button"] {
    padding: 10px 14px;
    border-radius: 12px;
    border: 1.5px solid #e4e4e4;
    box-shadow: 0 2.5px 8px 0 rgba(170,170,170,0.07);
    font-size: 1em;
    margin-top: 3px;
    background: #fcfcfc;
    transition: box-shadow 0.13s;
}
select:focus, .btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px #ee8e21;
    border: 1.5px solid #ee8e21;
}
.btn {
    background: linear-gradient(90deg, #ffa838 0%, #ffb440 80%);
    color: #fff;
    font-weight: bold;
    border: none;
    margin-top: 0;
    box-shadow: 0 4px 18px 0 rgba(255,168,56,0.09);
    cursor: pointer;
    min-width: 85px;
}
.btn:hover {
    filter: brightness(0.98);
}
.exportar-row {
    display: flex;
    gap: 14px;
    margin-bottom: 12px;
}
canvas {
    margin: 26px 0 10px 0;
    border-radius: 22px;
    box-shadow: 0 4px 20px 0 rgba(48,48,48,0.10);
    background: #f7f9fd;
}
#pregunta_id {
    min-width: 96%;
    width: 100%;
    height: 112px;
    font-size: 1.05em;
}
</style>

<div class="card-graficos">
    <h2 style="font-size:1.55em; color:#e86c1a; font-weight:800; letter-spacing:-1px;">
        Estadísticas y Proyecciones
    </h2>
    <form method="post" class="filtros-form" id="formFiltros">
        <label>Unidad:
            <select name="unidad_id" id="unidad_id" required>
                <option value="" disabled {% if not unidad_id or unidad_id=='todas' %}selected{% endif %}>Seleccione...</option>
                <option value="todas" {% if unidad_id == 'todas' %}selected{% endif %}>Todas</option>
                {% for u in unidades %}
                <option value="{{ u.id }}" {% if unidad_id == u.id|string %}selected{% endif %}>{{ u.nombre }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Preguntas:
            <select name="pregunta_id" id="pregunta_id" multiple required>
                <!-- Las preguntas se llenan dinámicamente por JS -->
            </select>
        </label>
        <label>Periodo:
            <select name="tipo_periodo" id="tipo_periodo">
                <option value="mensual" {% if tipo_periodo == 'mensual' %}selected{% endif %}>Mensual</option>
                <option value="trimestral" {% if tipo_periodo == 'trimestral' %}selected{% endif %}>Trimestral</option>
                <option value="semestral" {% if tipo_periodo == 'semestral' %}selected{% endif %}>Semestral</option>
                <option value="anual" {% if tipo_periodo == 'anual' %}selected{% endif %}>Anual</option>
            </select>
        </label>
        <button type="submit" class="btn">Filtrar</button>
    </form>

    <div class="exportar-row">
        <form id="exportarPDF" method="POST" action="{{ url_for('exportar_grafico_pdf') }}">
            <input type="hidden" name="grafico_img" id="grafico_img">
            <button type="button" class="btn" onclick="exportarPDF()">Exportar gráfico como PDF</button>
        </form>
    </div>

    <canvas id="graficoRespuestas" width="900" height="390"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ----- Variables desde Flask -----
    const preguntasPorUnidad = {{ preguntas_por_unidad|default({})|tojson }};
    const todasPreguntas = {{ todas_preguntas|default([])|tojson }};
    let preguntaSeleccionadas = {{ pregunta_ids|default([])|tojson }};
    let unidadId = "{{ unidad_id|default('todas', true) }}";

    // --- Llenar dinámicamente preguntas ---
    function cargarPreguntas(unidadIdSel) {
        let selectPreg = document.getElementById("pregunta_id");
        selectPreg.innerHTML = "";
        let preguntasMostrar = [];
        if (!unidadIdSel || unidadIdSel === "todas") {
            preguntasMostrar = todasPreguntas;
        } else if (preguntasPorUnidad[unidadIdSel]) {
            preguntasMostrar = preguntasPorUnidad[unidadIdSel];
        }
        preguntasMostrar.forEach((p, idx) => {
            let opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${idx + 1}. ${p.texto}`;
            if (preguntaSeleccionadas.includes(String(p.id)) || preguntaSeleccionadas.includes(p.id)) {
                opt.selected = true;
            }
            selectPreg.appendChild(opt);
        });
    }
    document.getElementById("unidad_id").addEventListener("change", function() {
        cargarPreguntas(this.value);
    });
    window.addEventListener('DOMContentLoaded', function() {
        cargarPreguntas(unidadId);
    });

    // ----- Gráfico Chart.js -----
    const etiquetas = {{ etiquetas|default([])|tojson }};
    const datos = {{ datos_grafico|default({})|tojson }};
    const proyeccion = {{ datos_proyeccion|default({})|tojson }};
    // Colores para datasets
    const colores = [
        "#e86c1a", "#1751d5", "#e1ad01", "#0db39e", "#ffa838", "#3356a3", "#cf4e8d", "#0c243c", "#ff4040", "#5cdb95"
    ];
    const coloresProy = [
        "rgba(232,108,26,0.35)", "rgba(23,81,213,0.25)", "rgba(225,173,1,0.25)", "rgba(13,179,158,0.22)"
    ];
    let datasets = [];
    Object.keys(datos).forEach((preg, i) => {
        datasets.push({
            label: preg,
            data: datos[preg],
            fill: false,
            borderWidth: 3.2,
            borderColor: colores[i % colores.length],
            pointBackgroundColor: "#fff",
            tension: 0.32,
            cubicInterpolationMode: "monotone"
        });
        // Proyección: mismo label + " (proyección)"
        datasets.push({
            label: preg + " (proyección)",
            data: proyeccion[preg],
            borderDash: [7,7],
            borderWidth: 3.2,
            fill: false,
            borderColor: coloresProy[i % coloresProy.length],
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0.32,
            cubicInterpolationMode: "monotone"
        });
    });

    let config = {
        type: 'line',
        data: {
            labels: etiquetas,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: "top" },
                title: {
                    display: true,
                    text: 'Evolución y Proyección a Fin de Año',
                    color: "#e86c1a",
                    font: { size: 20, weight: "bold" }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                x: {
                    title: { display: true, text: "Periodo", color: "#444", font: { weight: "bold" } }
                },
                y: {
                    beginAtZero: false,
                    title: { display: true, text: 'Valor', color: "#444", font: { weight: "bold" } }
                }
            }
        }
    };
    const ctx = document.getElementById('graficoRespuestas').getContext('2d');
    const grafico = new Chart(ctx, config);

function exportarPDF() {
    let canvas = document.getElementById('graficoRespuestas');
    let img = canvas.toDataURL("image/png");
    document.getElementById("grafico_img").value = img;
    document.getElementById("exportarPDF").submit();
}

    
</script>

{% endblock %}